<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gráfico do Painel Solar</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1220; --panel:#121a2b; --muted:#8ea0bf; --text:#e6eefc; --accent:#5b8cff; --accent-2:#7ee7f2; --ring:rgba(91,140,255,.5); }
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;background:radial-gradient(1200px 800px at 80% -10%, rgba(91,140,255,.15), transparent), var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0));border:1px solid rgba(255,255,255,0.08);box-shadow:0 20px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);border-radius:18px;padding:20px;backdrop-filter: blur(6px)}
    .title{display:flex;gap:12px;align-items:center;margin:8px 0 20px}
    .title h1{font-size:clamp(18px,2.6vw,24px);margin:0;letter-spacing:.2px}
    .title .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 0 10px var(--accent)}
    .grid{display:grid;grid-template-columns:1.2fr 1fr 1fr 1fr 1fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr 1fr}} @media (max-width:560px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type="date"],input[type="time"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.02);color:var(--text);outline:none;transition: box-shadow .15s ease, border-color .15s ease}
    select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
    .actions{display:flex;gap:12px;align-items:end}
    button{appearance:none;border:none;padding:12px 16px;border-radius:12px;font-weight:600;letter-spacing:.2px;background:linear-gradient(135deg,var(--accent),#6aa1ff);color:white;cursor:pointer;transition:transform .06s ease, filter .2s ease, box-shadow .2s ease;box-shadow:0 8px 18px rgba(91,140,255,.35)}
    button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
    .chart-wrap{margin-top:18px}
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .msg{margin-top:12px;font-size:14px;color:#d9e2ff;background:rgba(125,160,255,0.08);border:1px solid rgba(125,160,255,0.18);padding:10px 12px;border-radius:12px;display:none}
    .msg.error{color:#ffdede;background:rgba(255,93,93,0.08);border-color:rgba(255,93,93,0.24)}
    .legend{margin-top:6px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <div class="title"><span class="dot"></span><h1>Gráfico do Painel — intervalo customizado</h1></div>
    <div class="card">
      <div class="grid">
        <div>
          <label for="metric">Grandeza</label>
          <select id="metric">
            <option value="voltage">Tensão (V)</option>
            <option value="current_mA">Corrente (mA)</option>
            <option value="power_mW">Potência (mW)</option>
            <option value="lux">Luminosidade (lux)</option>
            <option value="temperature">Temperatura (°C)</option>
            <option value="humidity">Umidade (%)</option>
			<option value="irradiance">Irradiância (W/m²)</option>
          </select>
        </div>
        <div>
          <label for="startDate">Data inicial</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label for="startTime">Hora inicial</label>
          <input type="time" id="startTime" step="60" />
        </div>
        <div>
          <label for="endDate">Data final</label>
          <input type="date" id="endDate" />
        </div>
        <div>
          <label for="endTime">Hora final</label>
          <div class="actions">
            <input type="time" id="endTime" step="60" style="flex:1" />
            <button id="run">Exibir gráfico</button>
          </div>
        </div>
      </div>
      <div class="hint">O fuso é o do seu navegador; a API retorna ISO/UTC.</div>
      <div id="msg" class="msg"></div>
      <div class="chart-wrap">
        <canvas id="chart" height="110"></canvas>
        <div class="legend" id="legend"></div>
      </div>
    </div>
  </div>

  <script>
    function $(id){ return document.getElementById(id); }
    function pad(n){ return n.toString().padStart(2,'0'); }

    (function setDefaults(){
      const now = new Date();
      const start = new Date(now.getTime() - 60*60*1000);
      $('startDate').value = `${start.getFullYear()}-${pad(start.getMonth()+1)}-${pad(start.getDate())}`;
      $('startTime').value = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
      $('endDate').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
      $('endTime').value = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
    })();

	let chart;
	function ensureChart() {
	  const ctx = $('chart').getContext('2d');
	  if (chart) return chart;

	  const styles = getComputedStyle(document.documentElement);
	  const lineColor = styles.getPropertyValue('--accent').trim() || '#5b8cff';

	  chart = new Chart(ctx, {
		type: 'line',
		data: { datasets: [{ label: 'Valor', data: [], pointRadius: 0, tension: 0.15, borderWidth: 2, borderColor: lineColor }] },
		options: {
		  responsive: true,
		  scales: {
			  x: {
				type: 'time',
				time: {
				  displayFormats: {
					minute: 'HH:mm',
					hour: 'HH:mm',
					day: 'dd/MM HH:mm'
				  }
				},
				ticks: { maxRotation: 0 }
			  },
			  y: { beginAtZero: false }
			},
		  plugins: { legend: { display: false }, tooltip: { intersect: false, mode: 'index' } },
		  interaction: { intersect: false, mode: 'nearest' },
		  spanGaps: true
		}
	  });
	  return chart;
	}


    const API_URL = '/api/readings';

    async function fetchReadings(metric, startISO, endISO) {
      const url = new URL(API_URL, window.location.origin);
      url.searchParams.set('metric', metric);
      url.searchParams.set('start', startISO);
      url.searchParams.set('end', endISO);
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('Erro na API: ' + res.status);
      return res.json();
    }

    function toISO(dateStr, timeStr){
      const [y,m,d] = dateStr.split('-').map(Number);
      const [hh,mm] = timeStr.split(':').map(Number);
      const dt = new Date(y, m-1, d, hh, mm, 0);
      return dt.toISOString();
    }

    function unitFor(metric){
      return { voltage: 'V', current_mA: 'mA', power_mW: 'mW', lux: 'lux', temperature: '°C', humidity: '%' }[metric] || '';
    }

    $('run').addEventListener('click', async () => {
	  const metric = $('metric').value;
	  const startDate = $('startDate').value, startTime = $('startTime').value;
	  const endDate = $('endDate').value, endTime = $('endTime').value;
	  const msg = $('msg'); msg.style.display = 'none';

	  if (!startDate || !startTime || !endDate || !endTime) {
		msg.textContent = 'Preencha data e hora inicial e final.';
		msg.className = 'msg error'; msg.style.display = 'block'; return;
	  }

	  const startISO = toISO(startDate, startTime);
	  const endISO = toISO(endDate, endTime);

	  const c = ensureChart();
	  c.data.datasets[0].data = [];
	  c.update();

	  $('legend').textContent = `Exibindo: ${metric} (${unitFor(metric)}) de ${startISO} a ${endISO}`;

	  try {
		const raw = await fetchReadings(metric, startISO, endISO);

		// transforma em pontos {x,y}, ignorando null/undefined/NaN
		const points = raw.map(p => {
		  const y = p[metric] ?? p.value;     // backend pode mandar no campo da métrica ou em 'value'
		  if (y === null || y === undefined) return null;
		  const num = Number(y);
		  if (!Number.isFinite(num)) return null;
		  const localDate = new Date(p.ts); // já interpreta o ISO em UTC
		  // converte para ms local (UTC + offset do browser)
		  const localTime = new Date(localDate.getTime() + localDate.getTimezoneOffset() * 60000);
		  return { x: localTime, y: num };
		}).filter(Boolean);

		c.data.datasets[0].label = `${metric} (${unitFor(metric)})`;
		c.data.datasets[0].data = points;
		c.update();

		if (!points.length) {
		  msg.textContent = 'Nenhum dado para o intervalo selecionado.';
		  msg.className = 'msg'; msg.style.display = 'block';
		}
	  } catch (err) {
		msg.textContent = 'Erro ao carregar dados: ' + err.message;
		msg.className = 'msg error'; msg.style.display = 'block';
	  }
	});

  </script>
</body>
</html>
